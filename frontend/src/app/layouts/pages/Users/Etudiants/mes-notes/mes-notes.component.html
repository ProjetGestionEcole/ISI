<div class="grid">
  <div class="col-12">
    <div class="card">
      <div class="flex justify-between align-items-center mb-4">
        <h2>Mes Notes</h2>
        <div class="flex gap-2">
          <p-select 
            [options]="semesters" 
            [(ngModel)]="selectedSemester"
            optionLabel="nom"
            placeholder="Sélectionner un semestre"
            (onChange)="onSemesterChange()"
            [style]="{'min-width': '200px'}">
          </p-select>
          <p-button 
            label="Exporter" 
            icon="pi pi-download" 
            severity="secondary"
            (onClick)="exportGrades()">
          </p-button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid mb-4">
        <div class="col-12 md:col-3">
          <div class="surface-card p-3 border-round">
            <div class="text-900 font-medium text-xl mb-2">
              {{ notes().length }}
            </div>
            <div class="text-600">Notes Totales</div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="surface-card p-3 border-round">
            <div class="text-900 font-medium text-xl mb-2">
              {{ calculateAverage() | number:'1.2-2' }}
            </div>
            <div class="text-600">Moyenne Générale</div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="surface-card p-3 border-round">
            <div class="text-900 font-medium text-xl mb-2">
              <p-tag 
                [value]="calculateAverage() >= 10 ? 'Admis' : 'En cours'"
                [severity]="calculateAverage() >= 10 ? 'success' : 'warning'">
              </p-tag>
            </div>
            <div class="text-600">Statut</div>
          </div>
        </div>
        <div class="col-12 md:col-3">
          <div class="surface-card p-3 border-round">
            <div class="text-900 font-medium text-xl mb-2">
              {{ selectedSemester?.nom || 'Tous' }}
            </div>
            <div class="text-600">Semestre</div>
          </div>
        </div>
      </div>

      <!-- Search Bar -->
      <div class="mb-3">
        <span class="block mt-2 md:mt-0 p-input-icon-left">
          <i class="pi pi-search"></i>
          <input 
            pInputText 
            type="text" 
            (input)="applyFilterGlobal($event, 'contains')" 
            placeholder="Rechercher par matière..." 
            class="w-full sm:w-auto"
          />
        </span>
      </div>

      <!-- Notes Table -->
      <p-table 
        #dt 
        [value]="notes()" 
        [columns]="cols"
        [paginator]="true" 
        [rows]="10" 
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} notes"
        [rowsPerPageOptions]="[10, 25, 50]"
        [loading]="loading()"
        dataKey="id"
        [globalFilterFields]="['matiere.name', 'type_evaluation']">
        
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="matiere.name">
              Matière 
              <p-sortIcon field="matiere.name"></p-sortIcon>
            </th>
            <th pSortableColumn="type_evaluation">
              Type d'évaluation
              <p-sortIcon field="type_evaluation"></p-sortIcon>
            </th>
            <th pSortableColumn="note_mcc">
              Note MCC
              <p-sortIcon field="note_mcc"></p-sortIcon>
            </th>
            <th pSortableColumn="note_examen">
              Note Examen
              <p-sortIcon field="note_examen"></p-sortIcon>
            </th>
            <th pSortableColumn="valeur">
              Note Finale
              <p-sortIcon field="valeur"></p-sortIcon>
            </th>
            <th pSortableColumn="coefficient">
              Coefficient
              <p-sortIcon field="coefficient"></p-sortIcon>
            </th>
            <th pSortableColumn="date_evaluation">
              Date
              <p-sortIcon field="date_evaluation"></p-sortIcon>
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-note>
          <tr>
            <td>{{ note.matiere?.name }}</td>
            <td>{{ note.type_evaluation }}</td>
            <td>
              @if (note.note_mcc) {
                <p-tag 
                  [value]="note.note_mcc" 
                  [severity]="getGradeStatus(note.note_mcc)">
                </p-tag>
              } @else {
                <span class="text-muted">-</span>
              }
            </td>
            <td>
              @if (note.note_examen) {
                <p-tag 
                  [value]="note.note_examen" 
                  [severity]="getGradeStatus(note.note_examen)">
                </p-tag>
              } @else {
                <span class="text-muted">-</span>
              }
            </td>
            <td>
              <p-tag 
                [value]="note.valeur" 
                [severity]="getGradeStatus(note.valeur)">
              </p-tag>
            </td>
            <td>{{ note.coefficient }}</td>
            <td>{{ note.date_evaluation | date:'short' }}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center p-4">
              Aucune note disponible pour le semestre sélectionné
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
